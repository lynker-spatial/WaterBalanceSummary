<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>WaterBalance • WaterBalanceSummary</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="WaterBalance">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WaterBalanceSummary</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/BasinData.html">BasinData</a></li>
    <li><a class="dropdown-item" href="../articles/WaterBalance.html">WaterBalance</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/wamclean/WaterBalanceSummary/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>WaterBalance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/wamclean/WaterBalanceSummary/blob/main/vignettes/WaterBalance.Rmd" class="external-link"><code>vignettes/WaterBalance.Rmd</code></a></small>
      <div class="d-none name"><code>WaterBalance.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/wamclean/WaterBalanceSummary" class="external-link">WaterBalanceSummary</a></span><span class="op">)</span></span></code></pre></div>
<p>Note: As of 9/2/2024 the package is formatted to process CABCM and
TerraClimate data. As NextGen data becomes available any adjustments
that need be made to allow it to work within this flow will be made.
Until that point, this document will refer to CABCM and Terra data with
the implication that NextGen could be substituted for either at any
point.</p>
<div class="section level2">
<h2 id="creating-waterbalance-and-percent-error-by-season-plots">
<strong>Creating WaterBalance and Percent Error By Season
Plots</strong><a class="anchor" aria-label="anchor" href="#creating-waterbalance-and-percent-error-by-season-plots"></a>
</h2>
</div>
<div class="section level2">
<h2 id="set-aws-credentials">
<strong>Set AWS Credentials</strong><a class="anchor" aria-label="anchor" href="#set-aws-credentials"></a>
</h2>
<p>The first step will be to set AWS Credentials Globally so that you
can access the data held in the tnc-dangermond bucket.</p>
<div class="section level5">
<h5 id="define-the-theme">
<strong>Define the Theme</strong><a class="anchor" aria-label="anchor" href="#define-the-theme"></a>
</h5>
<p><strong>Optional</strong> Set a common theme for all of your plots.
If you want them to look like the examples here, you can use this code
chunk:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theme_pers</span> <span class="op">&lt;-</span><span class="kw">function</span> <span class="op">(</span><span class="va">base_size</span> <span class="op">=</span> <span class="fl">7</span>, <span class="va">base_family</span> <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span></span>
<span>    line <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">0.3</span>, linetype <span class="op">=</span> <span class="fl">1</span>, lineend <span class="op">=</span> <span class="st">"butt"</span><span class="op">)</span>,</span>
<span>    rect <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, colour <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">0.3</span>, linetype <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>family <span class="op">=</span> <span class="va">base_family</span>, face <span class="op">=</span> <span class="st">"plain"</span>, colour <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="va">base_size</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>, vjust <span class="op">=</span> <span class="fl">0.5</span>, angle <span class="op">=</span> <span class="fl">0</span>, lineheight <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>,</span>
<span>    axis.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    axis.line <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>vjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    axis.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    axis.ticks <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.title.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,</span>
<span>    axis.ticks.length <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>    axis.ticks.margin <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>    legend.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    legend.spacing <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>    legend.key <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    legend.key.size <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">1.2</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>    legend.key.height <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    legend.key.width <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    legend.text.align <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    legend.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>, hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    legend.title.align <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>    legend.direction <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    legend.justification <span class="op">=</span> <span class="st">"center"</span>,</span>
<span>    legend.box <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    panel.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>colour <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    panel.border <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">element_line</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"grey90"</span>, size <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.margin <span class="op">=</span> <span class="fu">unit</span><span class="op">(</span><span class="fl">0.25</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>    panel.margin.x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    panel.margin.y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    strip.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    strip.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    strip.text.y <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face<span class="op">=</span><span class="st">"bold"</span>, angle <span class="op">=</span> <span class="op">-</span><span class="fl">90</span><span class="op">)</span>,</span>
<span>    plot.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span>,</span>
<span>    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">rel</span><span class="op">(</span><span class="fl">1.2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    plot.margin<span class="op">=</span><span class="fu">unit</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span>,</span>
<span>    complete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="site-data">
<strong>Site Data</strong><a class="anchor" aria-label="anchor" href="#site-data"></a>
</h5>
<p>The assumption is that you already have site data that fits this
format:</p>
<p><img src="images%2FSiteDataExample.png"></p>
</div>
<div class="section level5">
<h5 id="divides">
<strong>Divides</strong><a class="anchor" aria-label="anchor" href="#divides"></a>
</h5>
<p>You also need to bring in your Basin Divides layer for mapping
purposes.</p>
<p><img src="images%2FHydrofabricExample.png"></p>
</div>
<div class="section level5">
<h5 id="pull-model-data">
<strong>Pull Model Data</strong><a class="anchor" aria-label="anchor" href="#pull-model-data"></a>
</h5>
<p>The data pulls assume access to the tnc-dangermond bucket and its
folders which contain the updated model data for the Dangermond
Preserve.</p>
</div>
<div class="section level5">
<h5 id="pull-cabcm-data">
<strong>Pull CABCM Data</strong><a class="anchor" aria-label="anchor" href="#pull-cabcm-data"></a>
</h5>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#new_cabcm_data &lt;- CABCMParquetRead()</span></span></code></pre></div>
<p>The CABCMParquetRead() function lists all Parquet files in the
specified subfolder within the base folder, it then reads each parquet
file into a data frame, stores them in a list, and combines all data
frames in the list into a single data frame with an additional column
`file` indicating the file from which each row was read.</p>
<p>The end product should look like this:</p>
<p><img src="images%2Fnew_cabcm_data.png"></p>
</div>
<div class="section level5">
<h5 id="pull-terraclimate-data">
<strong>Pull TerraClimate Data</strong><a class="anchor" aria-label="anchor" href="#pull-terraclimate-data"></a>
</h5>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#new_terraclim_data &lt;- TerraParquetRead()</span></span></code></pre></div>
<p>The TerraClimParquetRead function performs the same steps as the
CABCMParquetRead() function with the added step that it transforms the
`var` column to standardize variable names, changing “q” to “run” and
“soil” to “str”</p>
</div>
<div class="section level5">
<h5 id="clean-model-data">
<strong>Clean Model Data</strong><a class="anchor" aria-label="anchor" href="#clean-model-data"></a>
</h5>
<p>The above data has a variable, str, which represents soil moisture
storage. To accurately balance the basin’s water budget, we need to
convert this from total storage to the change in storage between two
time steps.</p>
<p>model_clean() separates out the soil moisture storage “str” from the
“var” field and calculates day to day change in storage before joining
that data back into the primary dataset for analysis. The output is
cabcm_delta_str or terra_delta_str.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#model_clean(new_cabcm_data)</span></span></code></pre></div>
<p>From this:</p>
<p><img src="images%2Fnew_cabcm_data.png" width="425"></p>
<p>To this:</p>
<p><img src="images%2Fmodel_delta_str.png" width="427"></p>
</div>
<div class="section level5">
<h5 id="process-model-data">
<strong>Process Model Data</strong><a class="anchor" aria-label="anchor" href="#process-model-data"></a>
</h5>
<p>What we have so far is great, but it isn’t accounting for error. If
the input to our system is Precipitation, PPT, and the out puts are
Actual Evapotranspiration, Stream Recharge, Runoff, and Change in Soil
Moisture Storage, we can better balance our system by finding error with
the following equation.</p>
<p>ERR = ppt - aet - rch - run - str</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#result_cabcm &lt;- process_model_data(cabcm_delta_str, NewDivides)</span></span></code></pre></div>
<p>The process_model_data() function does this and more.</p>
<p>It widens the dataframe, calculates the error for each timestamp,
assigns seasons based on month, calculates average error per season, and
the percent error against PPT. It then joins the seasonal data with the
<code>NewDivides</code> dataset to create a spatial dataframe, which is
split into four seasonal datasets. The final output is a list containing
seasonal data that can be used for generating Percent Error Plots based
on the season.</p>
<p><img src="images%2Fresult_data.png"></p>
<p>In addition to prepping the data for Seasonal Error plot, the
function assigns the widened data, such as “cabcm_data_wide” to the
global environment to be used in the balance_data() function below and
create our water balance plots.</p>
</div>
<div class="section level5">
<h5 id="plot-seasons">
<strong>Plot Seasons</strong><a class="anchor" aria-label="anchor" href="#plot-seasons"></a>
</h5>
<p>plot_seasons() generates standardized plots for based on the above
seasonal data. The plots visualize the percent error across different
spatial features for a given season. This function is designed to be
used within the <code>GridSeasons()</code> function to arrange the plots
in a grid layout.</p>
<p>You can customize it as suits you, but I have found this format to be
very appealing visually.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PlotSeason</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">SeasonData</span>, <span class="va">season_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">annotation_map_tile</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"osm"</span>, zoomin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_sf</span><span class="op">(</span>crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="fl">26910</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="fu">glue</span><span class="op">(</span><span class="st">"{season_name}"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># Use the season name for the title</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">SeasonData</span>, <span class="va">type</span> <span class="op">!=</span> <span class="st">"coastal"</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"grey"</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">percent_error</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Percent Error"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_gradient</span><span class="op">(</span>low <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"red4"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">theme</span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>          plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>          plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="seasons-plot">
<strong>Seasons Plot</strong><a class="anchor" aria-label="anchor" href="#seasons-plot"></a>
</h5>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#SeasonsPlot &lt;- GridSeasons(result_cabcm)</span></span></code></pre></div>
<p>GridSeasons() arranges and formats seasonal plots generated by the
<code>PlotSeason</code> function into a 2x2 grid layout. It uses the
output from <code><a href="../reference/process_model_data.html">process_model_data()</a></code> and customizes the plot
titles and captions based on the data source, be it CABCM, Terra, or
(pending) NextGen</p>
<p><img src="images%2FExampleSeasonPlot.png"></p>
</div>
<div class="section level5">
<h5 id="balance-data">
<strong>Balance Data()</strong><a class="anchor" aria-label="anchor" href="#balance-data"></a>
</h5>
<p>balance_data() relies on terra_ or cabcm_data_wide from the
process_data() function above. It formats the data so that it can be
used to create the Water Balance Plots.</p>
<p>The new data should look like this:</p>
<p><img src="images%2Fwater_balance_output.png"></p>
</div>
<div class="section level5">
<h5 id="water-balance-plots">
<strong>Water Balance Plots</strong><a class="anchor" aria-label="anchor" href="#water-balance-plots"></a>
</h5>
<p>CreateWaterBalancePlot() uses the output of balance_data(), terra_ or
cabcm_long_balance, and creates a water balance plot comparing the
inputs and outputs of the system.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#combined_plot &lt;- CreateWaterBalancePlot(x = terra_long_balance)</span></span></code></pre></div>
<p><img src="images%2FExampleBalancePlot.png"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Billy McLean, TNC, Lynker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
